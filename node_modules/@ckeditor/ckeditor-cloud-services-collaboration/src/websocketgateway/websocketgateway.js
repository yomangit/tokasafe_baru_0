/*
 *             Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{io}from'socket.io-client';import _0x1bb9bb from'url-parse';import{ObservableMixin,priorities,global}from'ckeditor5/src/utils.js';import _0x540105 from'./channel.js';import _0xac1524 from'./../users/user.js';import _0x539a3e from'./../version.js';import _0x2b48d8 from'./../ckeditorcloudserviceserror.js';import _0x46dcc3 from'./../ckeditorcloudservicesservererror.js';import{Encoder,Decoder}from'./parser/parser.js';import _0x2efe52 from'./requestsmanager.js';export const WEB_SOCKET_GATEWAY_STATES={'DISCONNECTED':'disconnected','CONNECTING':'connecting','CONNECTED':'connected'};class WebSocketGateway extends/* #__PURE__ -- @preserve */
ObservableMixin(){constructor(_0x1fd0a0,_0x1b827d,_0x15d225,_0x2f4376,_0xd70d7e){if(super(),this['_connectionAttempt']=0x0,this['_token']=_0x1b827d,this['_options']=null!=_0x15d225?_0x15d225:{},this['_connectionProvider']=null!=_0x2f4376?_0x2f4376:io,this['_userFactory']=null!=_0xd70d7e?_0xd70d7e:_0xac1524['get'],this['_requestsManager']=new _0x2efe52(this),this['_channels']=new Map(),!_0x1fd0a0)throw new TypeError('Api\x20address\x20must\x20be\x20provided.');if(!this['_token'])throw new TypeError('Token\x20must\x20be\x20provided.');this['_options']['requestTimeout']||(this['_options']['requestTimeout']=0x4e20),this['_url']=_0x1bb9bb(_0x1fd0a0['replace'](/^(?!(?:\w+:)?\/\/)/,'https://')),this['set']('state',WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']),this['set']('socketId',void 0x0),this['set']('me',void 0x0),this['on']('change:state',async(_0xd4629,_0x3e43bd,_0x20be42)=>{var _0x55a54d;if(this['_debugEvent']('ws-gw:change:state',_0x20be42),_0x20be42!==WebSocketGateway['STATE_CONNECTED']){if(_0x20be42===WebSocketGateway['STATE_DISCONNECTED'])return this['_requestsManager']['errorAll'](new _0x2b48d8('Not\x20connected.',this));}else try{this['me']=await this['_userFactory']['call'](_0xac1524,this,null===(_0x55a54d=this['_socketAuth'])||void 0x0===_0x55a54d?void 0x0:_0x55a54d['userId']);}catch(_0x12a59d){}},{'priority':WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']}),this['on']('error',(_0x1d6bc0,_0x459629)=>{this['_options']['onError']?this['_options']['onError'](_0x459629):console['error'](_0x459629);});}get['sessionId'](){return this['socketId'];}['waitForAllRequests'](_0x330e94){return this['_requestsManager']['waitForAllRequests'](_0x330e94);}['disconnect'](){var _0x45abe3;this['state']!==WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']&&(null===(_0x45abe3=this['_socket'])||void 0x0===_0x45abe3||_0x45abe3['disconnect'](),this['_socket']=void 0x0,this['state']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']);}async['reconnect'](){this['_socket']||this['state']!==WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']||(await this['_token']['refreshToken'](),await this['_connect']());}static async['connect'](_0x2b9246,_0x586835='local.cs.dev:443/ws-v2',_0x3246b5={},_0x4a92dd=io,_0x3628ca=_0xac1524['get']){const _0x1d193c=new WebSocketGateway(_0x586835,_0x2b9246,_0x3246b5,_0x4a92dd,_0x3628ca);return await _0x1d193c['_connect'](),_0x1d193c;}['_sendRequest'](_0x234a19,_0x48a17a,_0x12f98d){if(!_0x234a19)throw new _0x2b48d8('`serviceName`\x20must\x20be\x20provided.',this);if(this['state']!==WebSocketGateway['STATE_CONNECTED'])throw new _0x2b48d8('Not\x20connected.',this);if(!this['_socketAuth']||!this['_socketAuth']['isAuthenticated'])throw new _0x2b48d8('Not\x20authenticated.',this);const _0x290cd5=new ArrayBuffer(_0x12f98d['length']+0x2),_0x44a3b9=new Uint8Array(_0x290cd5);return _0x44a3b9[0x0]=_0x234a19,_0x44a3b9[0x1]=parseInt(_0x48a17a),_0x44a3b9['set'](_0x12f98d,0x2),this['_emit'](0x1,_0x44a3b9);}['_getChannel'](_0x151c78,_0x4bbc1d){const _0x46f538=''+_0x151c78+_0x4bbc1d;return!this['_channels']['has'](_0x46f538)&&this['_socket']&&this['_channels']['set'](_0x46f538,new _0x540105(_0x46f538,this,this['_socket'])),this['_channels']['get'](_0x46f538);}['_connect'](){return new Promise((_0x2b6e8d,_0x319348)=>{const _0x508a50=this['_setupSocket']();!this['socketId']&&_0x508a50['io']['on']('reconnect_error',()=>{this['_debugEvent']('reconnect_error'),this['_reconnectionAttemptError'](_0x319348);}),_0x508a50['once']('connect',async()=>{this['_debugEvent']('once-connect');try{await this['_onConnect'](),_0x2b6e8d();}catch(_0x1d2569){_0x319348(_0x1d2569);}}),_0x508a50['connect']();});}['_getPortByProtocol'](_0x1168ec){return['http:','ws:']['includes'](_0x1168ec)?0x50:0x1bb;}['_setupSocket'](){var _0x4cb8ba;if(this['_socket'])return this['_socket'];const _0x16c4a2=this['_url']['port']||this['_getPortByProtocol'](this['_url']['protocol']),_0x44835a=(this['_url']['protocol']||'https:')+'//'+this['_url']['hostname']+':'+_0x16c4a2,_0x52c95d=this['_url']['pathname']['match'](/^\/.*\/ws/)?this['_url']['pathname']['split']('/ws')[0x0]:'',_0x1888d4=this['_connectionProvider'](_0x44835a,{'parser':{'Encoder':Encoder,'Decoder':Decoder},'path':_0x52c95d+'/ws-v2/ws','transports':['websocket'],'timeout':void 0x0!==this['_options']['timeout']?this['_options']['timeout']:0x1388,'reconnection':void 0x0===this['_options']['autoReconnect']||this['_options']['autoReconnect'],'reconnectionDelay':0x3e8,'reconnectionDelayMax':0x1388,'rejectUnauthorized':void 0x0===this['_options']['rejectUnauthorized']||this['_options']['rejectUnauthorized'],'query':{'version':_0x539a3e},'agent':null!==(_0x4cb8ba=this['_options']['agent'])&&void 0x0!==_0x4cb8ba&&_0x4cb8ba,'closeOnBeforeunload':!0x1});return this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],_0x1888d4['on']('connect',()=>{this['_debugEvent']('connect'),this['socketId']=_0x1888d4['id'];}),_0x1888d4['on']('connect_error',_0x8a543a=>{this['_debugEvent']('connect_error',_0x8a543a);}),_0x1888d4['on']('disconnect',()=>{this['_debugEvent']('disconnect'),this['_onDisconnect']();}),_0x1888d4['io']['on']('reconnect',async()=>{this['_debugEvent']('reconnect'),await this['_onReconnect']();}),_0x1888d4['io']['on']('reconnect_attempt',_0x3a46f6=>{this['_debugEvent']('reconnect_attempt',_0x3a46f6),this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],this['_connectionAttempt']=_0x3a46f6;}),_0x1888d4['on']('unauthorized',_0x17d7a9=>{this['_debugEvent']('unauthorized'),this['_onUnauthorized'](_0x17d7a9);}),_0x1888d4['on']('authenticationRequest',async _0x1efa2e=>{this['_debugEvent']('authenticationRequest',_0x1efa2e['attempt']),await this['_onReconnect']();}),this['_socket']=_0x1888d4,_0x1888d4;}['_emit'](_0x5e6b3f,_0x38cd1f){const _0x4dbe3a=this['_socket'];return this['_requestsManager']['send'](_0x16d446=>{_0x4dbe3a['emit'](_0x5e6b3f,_0x38cd1f,(_0xcd3ed1,_0x305185)=>{if(_0xcd3ed1)return _0x16d446['error'](_0x46dcc3['fromPublicError'](_0xcd3ed1));_0x16d446['response'](_0x305185);});},this['_options']['requestTimeout']);}['_addAuthData'](_0x2ed80b,_0x40449c){this['_socketAuth']={'environmentId':_0x2ed80b,'userId':_0x40449c,'isAuthenticated':!0x0};}['_removeAuthData'](){this['_socketAuth']=void 0x0;}async['_onConnect'](){await this['_authenticate'](this['_token']['value']),this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTED'];const _0x22059a=async(_0x5d9788,_0x1fc40b,_0x6cd3f4)=>{this['_debugEvent']('token:value:change');try{await this['_authenticate'](_0x6cd3f4);}catch(_0xc3d613){}};this['_token']['on']('change:value',_0x22059a),this['_socket']['io']['off']('reconnect_error'),this['on']('disconnect',()=>{this['_token']['off']('change:value',_0x22059a);});}async['_onReconnect'](){await this['_token']['refreshToken'](),await this['_onConnect']();}['_onDisconnect'](){this['state']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED'],this['_connectionAttempt']=0x0,this['fire']('disconnect');for(const _0x3849c5 of this['_channels']['values']())_0x3849c5['remove']();this['_channels']['clear'](),void 0x0===this['_options']['autoReconnect']||this['_options']['autoReconnect']||(this['_socket']=void 0x0);}['_debugEvent'](_0x58a3dc,_0x32ff58){if(!this['_isDebugModeEnabled']())return;const _0x521d27=void 0x0!==_0x32ff58?',\x20data:\x20'+_0x32ff58:'';console['info'](new Date()['toLocaleString']()+'\x20'+_0x58a3dc+_0x521d27);}['_reconnectionAttemptError'](_0x5dc65d){this['_connectionAttempt']>=0x2&&(this['disconnect'](),_0x5dc65d(_0x2b48d8['fromPublicError']({'message':'The\x20number\x20of\x20initial\x20connection\x20attempts\x20exceeded.','explanation':'Three\x20initial\x20connection\x20attempts\x20failed.\x20It\x20can\x20be\x20caused\x20by\x20a\x20slow,\x20unstable,\x20missing\x20or\x20blocked\x20Internet\x20connection.','action':'Please\x20verify\x20the\x20stability\x20of\x20your\x20Internet\x20connection\x20and\x20ensure\x20that\x20no\x20antivirus\x20or\x20firewall\x20software\x20blocks\x20the\x20Web\x20Socket\x20protocol\x20connections.'})));}['_onUnauthorized']({error:_0x1675d2}){this['_removeAuthData'](),this['fire']('error',_0x46dcc3['fromPublicError'](_0x1675d2));}async['_authenticate'](_0x178bb1){try{this['_debugEvent']('authenticate:start');const _0x2eabf4=await this['_emit'](0x2,{'token':_0x178bb1});this['_debugEvent']('authenticate:success','envId:\x20'+_0x2eabf4['environmentId']+',\x20userId:\x20'+_0x2eabf4['userId']),this['_addAuthData'](_0x2eabf4['environmentId'],_0x2eabf4['userId']);}catch(_0x551199){throw this['_debugEvent']('authenticate:error',_0x551199['message']),this['_removeAuthData'](),_0x551199;}}['_isDebugModeEnabled'](){var _0x270050;if(!global['window']['localStorage'])return!0x1;return'true'===(null!==(_0x270050=global['window']['localStorage']['getItem']('csClientDebugMode'))&&void 0x0!==_0x270050?_0x270050:'false')['toLowerCase']();}}WebSocketGateway['STATE_DISCONNECTED']=/* #__PURE__ -- @preserve */
((()=>WEB_SOCKET_GATEWAY_STATES['DISCONNECTED'])()),WebSocketGateway['STATE_CONNECTING']=/* #__PURE__ -- @preserve */
((()=>WEB_SOCKET_GATEWAY_STATES['CONNECTING'])()),WebSocketGateway['STATE_CONNECTED']=/* #__PURE__ -- @preserve */
((()=>WEB_SOCKET_GATEWAY_STATES['CONNECTED'])()),WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']=/* #__PURE__ -- @preserve */
((()=>priorities['get']('highest')+0xf423f)());export default WebSocketGateway;