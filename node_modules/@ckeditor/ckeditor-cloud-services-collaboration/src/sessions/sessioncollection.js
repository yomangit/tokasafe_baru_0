/*
 *             Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{Collection}from'ckeditor5/src/utils.js';import _0x41494a from'./../users/user.js';import _0x2faefd from'./../websocketgateway/websocketgateway.js';import _0x49efdb from'./responses/sessionsconnectresponse.js';import _0x4564fa from'./messages/sessionsconnectmessage.js';import _0x3ca8af from'./messages/socketconnectmessage.js';import _0x436a4a from'./messages/socketdisconnectmessage.js';import _0x345885 from'./../messagescompressor.js';export const _SERVICE=0x3;export default class extends Collection{constructor(_0x10d82f,_0x2c932b){super({'idProperty':'id'}),this['_id']=_0x10d82f,this['_sessionType']=_0x2c932b,this['_handlers']=new Map(),this['_eventsQueue']=[],this['_isRunning']=!0x1;}async['connect'](_0x2f0625){this['_wsGateway']=_0x2f0625,this['stopListening'](_0x2f0625,'change:state');const _0x5524c1=new _0x4564fa(this['_id'],this['_sessionType']);let _0x17674f;try{const _0x748d53=await this['_wsGateway']['_sendRequest'](0x3,_0x4564fa['TYPE'],_0x345885['encode'](_0x5524c1));_0x17674f=_0x345885['decode'](_0x748d53,_0x49efdb);}catch(_0x2abef9){_0x17674f=new _0x49efdb(this['_id'],[]);}this['_connectToChannel'](this['_wsGateway'],_0x17674f['channel'],this['_sessionType']);const _0x1a3007=await async function(_0x17efb3,_0x26ddd8){const _0x3cb499=_0x26ddd8['map'](_0x4f53fb=>_0x4f53fb['userId']),_0x229dc2=_0x3cb499['length']?await _0x41494a['getMany'](_0x17efb3,_0x3cb499):[];return _0x26ddd8['map'](_0x4e124b=>{const _0x42d40f={'id':_0x4e124b['id'],'role':_0x4e124b['role'],'permissions':_0x4e124b['permissions']};return _0x42d40f['user']=_0x4e124b['userId']&&_0x229dc2['find'](_0x2c40c4=>_0x2c40c4['id']===_0x4e124b['userId'])||new _0x41494a(),_0x42d40f;});}(this['_wsGateway'],_0x17674f['sockets']);for(const _0x53a729 of _0x1a3007)super['add'](_0x53a729);this['_connected']=!0x0,this['fire']('connected'),this['listenTo'](this['_wsGateway'],'change:state',(_0x53b2ef,_0x3df1fa,_0x2bbac1)=>this['_onWsGatewayStateChange'](_0x2bbac1),{'priority':_0x2faefd['_CHANGE_STATE_EVENT_PRIORITY']}),await this['_runQueue']();}['disconnect'](_0x3befa1=!0x0){if(this['_connected']){for(this['_connected']=!0x1,this['_eventsQueue']=[];this['length'];)super['remove'](0x0);this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_wsGateway']&&_0x3befa1&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['fire']('disconnected'),_0x3befa1&&this['stopListening']();}}['add'](_0x2fbd7e,_0x26e8ae){throw new TypeError('The\x20collection\x20is\x20read-only.');}['remove'](_0x333ec){throw new TypeError('The\x20collection\x20is\x20read-only.');}['_connectToChannel'](_0x4a23a6,_0x107b68,_0x45c126){this['_channel']=_0x4a23a6['_getChannel'](_0x45c126,_0x107b68),this['_channel']&&(this['_addHandler'](this['_channel'],_0x3ca8af['TYPE'],async _0x18061d=>{const _0x27fc1e=_0x345885['decode'](_0x18061d,_0x3ca8af);if(-0x1===this['getIndex'](_0x27fc1e['id'])){const _0x4eeb86={'id':_0x27fc1e['id'],'role':_0x27fc1e['role'],'permissions':_0x27fc1e['permissions']};_0x27fc1e['userId']&&(_0x4eeb86['user']=await _0x41494a['get'](_0x4a23a6,_0x27fc1e['userId'])),super['add'](_0x4eeb86);}}),this['_addHandler'](this['_channel'],_0x436a4a['TYPE'],_0x2333e3=>{const _0x45f8fb=_0x345885['decode'](_0x2333e3,_0x436a4a);-0x1!==this['getIndex'](_0x45f8fb['id'])&&super['remove'](_0x45f8fb['id']);}));}async['_onWsGatewayStateChange'](_0x402e03){_0x402e03===_0x2faefd['STATE_DISCONNECTED']&&this['disconnect'](!0x1),_0x402e03===_0x2faefd['STATE_CONNECTED']&&await this['connect'](this['_wsGateway']);}async['_runQueue'](){if(this['_isRunning']||!this['_connected'])return;let _0x335935;for(this['_isRunning']=!0x0;_0x335935=this['_eventsQueue']['shift']();){const _0x11d550=this['_handlers']['get'](_0x335935['eventName']);_0x11d550&&await _0x11d550(_0x335935['data']);}this['_isRunning']=!0x1;}['_addHandler'](_0x1b7798,_0x3199cf,_0x309783){const _0x2468a1=_0x1b7798['getEventName'](_0x3199cf,!0x0);this['listenTo'](_0x1b7798,_0x2468a1,async(_0x3663ee,_0x21a1b6)=>{const _0x22484d=_0x3663ee['name'];this['_eventsQueue']['push']({'eventName':_0x22484d,'data':_0x21a1b6}),await this['_runQueue']();}),this['_handlers']['set'](_0x2468a1,_0x309783);}}