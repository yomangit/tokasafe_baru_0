/*
 *             Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{v4 as _0x4ec587}from'uuid';import{EmitterMixin}from'ckeditor5/src/utils.js';import _0x254cfa from'./../messagescompressor.js';import _0x19d336 from'./../sessions/sessions.js';import _0x3ab870 from'./messages/collaborativeeditingconnectmessage.js';import _0x593b1f from'./messages/collaborativeeditingupdatemessage.js';import _0x4f943f from'./messages/collaborativeeditingreconnectmessage.js';import _0x119d16 from'./responses/collaborativeeditingresponse.js';import _0x5c02f2 from'./responses/collaborativeeditingconnectresponse.js';import _0xcda1f3 from'./../websocketgateway/websocketgateway.js';import _0x58e45c from'../ckeditorcloudserviceserror.js';import _0x13048 from'../errors/ServiceNotConnectedError.js';import _0x27702f from'./responses/getdocumentdetailsresponse.js';import _0xfc0a8d from'./messages/getdocumentdetailsmessage.js';export const _SERVICE=0x1;class CollaborativeEditingService extends/* #__PURE__ -- @preserve */
EmitterMixin(){constructor(_0x43a985,_0x2b0183){if(super(),!_0x43a985)throw new TypeError('Param\x20\x22bundleVersion\x22\x20must\x20be\x20provided.');this['_id']=null!=_0x2b0183?_0x2b0183:_0x4ec587(),this['_isConnected']=!0x1,this['_bundleVersion']=_0x43a985;}['getId'](){return this['_id'];}['isConnected'](){return this['_isConnected'];}['connect'](_0x269197,_0x666efd={'buffers':[],'types':[]},_0x260b42){const _0x2d558b=new _0x3ab870(this['getId'](),_0x666efd['buffers'],_0x666efd['types'],this['_bundleVersion'],_0x260b42);return this['_connect'](_0x269197,_0x2d558b);}['reconnect'](_0x493418,_0x41db67){if(this['isConnected']())throw new _0x58e45c('Cannot\x20reconnect\x20to\x20already\x20connected\x20service.',_0x493418);return this['_connect'](_0x493418,new _0x4f943f(this['getId'](),_0x41db67,this['_bundleVersion']));}['disconnect'](){this['_isConnected']&&(this['_isConnected']=!0x1,this['_wsGateway']&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_connectedSessions']&&(this['_connectedSessions']['disconnect'](),this['_connectedSessions']=void 0x0),this['fire']('disconnected'),this['stopListening']());}async['getDocumentDetails'](){const _0x47dd4f=new _0xfc0a8d(this['getId']());if(!this['_wsGateway'])throw new _0x13048('Collaborative\x20Editing',this);const _0x5d21de=await this['_wsGateway']['_sendRequest'](0x1,_0xfc0a8d['TYPE'],_0x254cfa['encode'](_0x47dd4f));return _0x254cfa['decode'](_0x5d21de,_0x27702f);}async['sendOperations'](_0x5f0fac,_0x629279,_0x2462d4){if(!_0x5f0fac||!_0x5f0fac['types']||!_0x5f0fac['types']['length'])throw new _0x58e45c('Cannot\x20send\x20empty\x20update.',this['_wsGateway']);const _0x3cf753='number'==typeof _0x629279?_0x629279:parseInt(_0x629279);if(!Number['isInteger'](_0x3cf753)||_0x3cf753<0x0)throw new _0x58e45c('Base\x20version\x20not\x20provided.',this['_wsGateway']);const _0x1e8668=new _0x593b1f(this['getId'](),_0x5f0fac['buffers'],_0x5f0fac['types'],_0x3cf753,[],_0x2462d4);if(!this['_wsGateway']||!this['_isConnected'])throw new _0x13048('Collaborative\x20Editing',this);const _0x435c9a=await this['_wsGateway']['_sendRequest'](0x1,_0x593b1f['TYPE'],_0x254cfa['encode'](_0x1e8668));return _0x254cfa['decode'](_0x435c9a,_0x119d16);}async['getConnectedSessions'](){if(!this['_isConnected'])throw new _0x13048('Collaborative\x20Editing',this);return this['_connectedSessions']||(this['_connectedSessions']=await _0x19d336['getConnectedSessions'](this['_wsGateway'],this['_id'],0x1)),this['_connectedSessions'];}static['getConnectedSessions'](_0x1462ea,_0x109b39){return _0x19d336['getConnectedSessions'](_0x1462ea,_0x109b39,0x1);}async['_connect'](_0x8d878c,_0x351b85){if(this['isConnected']())return;if(_0x8d878c['state']!==_0xcda1f3['STATE_CONNECTED'])throw new _0x58e45c('WebSocket\x20Gateway\x20is\x20not\x20connected.',_0x8d878c);this['_wsGateway']=_0x8d878c,this['stopListening'](_0x8d878c,'change:state');const _0x3bdea9=await _0x8d878c['_sendRequest'](0x1,_0x351b85['constructor']['TYPE'],_0x254cfa['encode'](_0x351b85)),_0x3137d7=_0x254cfa['decode'](_0x3bdea9,_0x5c02f2);return this['listenTo'](_0x8d878c,'change:state',(_0x15dda6,_0x276e47,_0x5b4e13)=>this['_onWsGatewayStateChange'](_0x5b4e13),{'priority':_0xcda1f3['_CHANGE_STATE_EVENT_PRIORITY']}),this['_connectToChannel'](_0x8d878c,_0x3137d7['channel']),this['_isConnected']=!0x0,this['fire']('connected'),_0x3137d7;}['_connectToChannel'](_0x54c3ad,_0x21d07d){this['_channel']=_0x54c3ad['_getChannel'](0x1,_0x21d07d),this['listenTo'](this['_channel'],this['_channel']['getEventName'](_0x593b1f['TYPE']),(_0xff7dfd,_0x5302ca)=>{const _0x3dba04=_0x254cfa['decode'](_0x5302ca,_0x593b1f);this['fire']('operationsReceived',_0x3dba04['baseVersion'],_0x3dba04['data'],_0x3dba04['metadata']);});}['_onWsGatewayStateChange'](_0x863f11){_0x863f11===_0xcda1f3['STATE_DISCONNECTED']&&this['disconnect']();}}CollaborativeEditingService['_SERVICE']=0x1;export default CollaborativeEditingService;